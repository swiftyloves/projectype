<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.19.custom.min.js"></script>
    <script type="text/javascript" src="js/1.3.9/jsPlumb-1.3.9-RC1.js"></script>
    <script type="text/javascript" src="js/1.3.9/jsPlumb-defaults-1.3.9-RC1.js"></script>
    <script type="text/javascript" src="js/1.3.9/jsPlumb-renderers-svg-1.3.9-RC1.js"></script>
    <script type="text/javascript" src="js/1.3.9/jquery.jsPlumb-1.3.9-RC1.js"></script>
    <script type="text/javascript" src="js/scrollsync.js"></script>
    <script type="text/javascript" src="js/dragscrollable.js"></script>
    <link type="text/css" href="css/reset.css" rel="stylesheet" />
    <link type="text/css" href="css/custom-theme/jquery-ui-1.8.19.custom.css" rel="stylesheet" />
    <link type="text/css" href="css/test4.css" rel="stylesheet" />
  </head>
<body>
  <button id="testButton">123</button>
  <div id="mainCanvas" title="Task">
    <div id="taskViewPort" class="viewPort">
      <div id="taskCanvas">
        <div id="container0" class="window"><span>haha0</span></div>
        <div id="container1" class="window"><span>haha1</span></div>
        <div id="container2" class="window"><span>haha2</span></div>
      </div>
    </div>
    <div id="timeViewPort" class="viewPort">
      <div id="timeBarDragHelper" class="dragHelper"></div>
      <div id="timeBar">
      <div class="dummyStart"></div>
      <div>1</div>
      <div>2</div>
      <div>3</div>
      <div>4</div>
      <div>5</div>
      <div>6</div>
      <div>7</div>
      <div>8</div>
      <div>9</div>
      <div>10</div>
      <div>11</div>
      <div>12</div>
      <div class="dummyEnd"></div>
      </div>
    </div>
  </div>
<script type="text/javascript">

  jsPlumb.setRenderMode(jsPlumb.SVG);
  jsPlumb.importDefaults({
    Connector: [ "Flowchart" ],
    PaintStyle: { strokeStyle:"rgb(203, 201, 150)", lineWidth:2},
    Anchors: [ "AutoDefault", "AutoDefault" ],

    ConnectionOverlays: [ ["Arrow", {location: 1, id:"arrow", length:14, foldback:0.8} ] ],

    Endpoint: [ "Blank" ],
  });
  jsPlumb.connect({ source:"container1", target:"container0" });
  jsPlumb.connect({ source:"container2", target:"container0" });

  var scrollThreshold = 30;
  var snapOffset = $($("#timeBar").children()[0]).offset().left;
  var snapUnit = $($("#timeBar").children()[1]).offset().left - $($("#timeBar").children()[0]).offset().left;


  jsPlumb.draggable($(".window"), { grid: [1,30], 
                                    containment: "#taskCanvas", 
                                    drag: function(event, ui) {
                                      var viewPort = $(this).parent().parent();
                                      var obj = $(this);
                                      var viewX = viewPort.outerWidth();
                                      var objX = obj.position().left + obj.outerWidth();
                                      var delta = objX - viewX;

                                      if (delta >= scrollThreshold) {
                                        viewPort.scrollLeft(viewPort.scrollLeft() + scrollThreshold);
                                      } else if (obj.position().left <= -scrollThreshold) {
                                        viewPort.scrollLeft(viewPort.scrollLeft() - scrollThreshold);
                                      }
                                      
                                    },
                                    stop: function(event, ui) {
                                      var tmp = Math.round(($(this).offset().left - snapOffset) / snapUnit) * snapUnit
                                                + snapOffset;
                                      $(this).offset({left: tmp});
                                      jsPlumb.repaintEverything();
                                    },
                                    stack: ".window",
                                    cursor: "move"});
 
  $(".viewPort, .dragHelper").dragscrollable({acceptPropagatedEvent: false});
  $(".viewPort, .dragHelper").scrollsync({targetSelector: "#timeViewPort", axis: "x"});
  $(".viewPort, .dragHelper").scrollsync({targetSelector: "#taskViewPort", axis: "x"});
  $(".viewPort, .dragHelper").scrollsync({targetSelector: "#timeBarDragHelper", axis: "x"});

  $('#mainCanvas').dialog({
    autoOpen: false,
    resizable: false,
    height: 470,
    width: 630,
    modal: true,
  });
  $('#testButton').click(function() {
    $('#mainCanvas').dialog('open');
  });

</script>
</body>
</html>
